import sqlite3
from datetime import datetime
import math

DB_NAME="parking.db"

def init_db():
    conn=sqlite3.connect(DB_NAME)
    c=conn.cursor()
    c.execute("PRAGMA journal_mode=WAL")  #Simultaneous Reading & Writing (Write-Ahead Logging)
    c.execute('''CREATE TABLE IF NOT EXISTS parking_config(id INTEGER PRIMARY KEY,total_floors INTEGER,car_slots INTEGER,bike_slots INTEGER,car_rate REAL,bike_rate REAL,wiggle_min INTEGER)''')
    c.execute('''CREATE TABLE IF NOT EXISTS active_parking(id INTEGER PRIMARY KEY,plate_number TEXT UNIQUE,vehicle_type TEXT,entry_time TEXT,image_path TEXT)''')
    c.execute('''CREATE TABLE IF NOT EXISTS transaction_history(id INTEGER PRIMARY KEY,plate_number TEXT,vehicle_type TEXT,entry_time TEXT,exit_time TEXT,duration_min REAL,total_fee REAL,image_path TEXT)''')
    c.execute("SELECT count(*) FROM parking_config")
    if c.fetchone()[0]==0:
        c.execute("INSERT INTO parking_config VALUES(1,2,16,10,20.0,10.0,5)")
    conn.commit()
    conn.close()

def get_config():
    conn=sqlite3.connect(DB_NAME)
    c=conn.cursor()
    c.execute("SELECT * FROM parking_config")
    cfg=c.fetchone()
    conn.close()
    return cfg

def update_config(floors,cars,bikes,c_rate,b_rate,wiggle):
    conn=sqlite3.connect(DB_NAME)
    c=conn.cursor()
    c.execute("UPDATE parking_config SET total_floors=?,car_slots=?,bike_slots=?,car_rate=?,bike_rate=?,wiggle_min=? WHERE id=1",(floors,cars,bikes,c_rate,b_rate,wiggle))
    conn.commit()
    conn.close()

def get_free_spots(v_type):
    cfg=get_config()
    limit=cfg[2] if v_type=='car' else cfg[3]
    conn=sqlite3.connect(DB_NAME)
    c=conn.cursor()
    c.execute("SELECT count(*) FROM active_parking WHERE vehicle_type=?",(v_type,))
    occupied=c.fetchone()[0]
    conn.close()
    return occupied,limit

def handle_vehicle(plate_text,v_type,img_path=None):
    conn=sqlite3.connect(DB_NAME)
    c=conn.cursor()
    c.execute("SELECT * FROM active_parking WHERE plate_number=?",(plate_text,))
    existing=c.fetchone()
    if existing:
        entry_time_str=existing[3]
        entry_img=existing[4]
        entry_time=datetime.strptime(entry_time_str,"%Y-%m-%d %H:%M:%S")
        total_fee,duration,exit_time=calculate_fee(entry_time,v_type)
        c.execute("DELETE FROM active_parking WHERE plate_number=?",(plate_text,))
        c.execute("INSERT INTO transaction_history(plate_number,vehicle_type,entry_time,exit_time,duration_min,total_fee,image_path) VALUES(?,?,?,?,?,?,?)",(plate_text,v_type,entry_time_str,exit_time.strftime("%Y-%m-%d %H:%M:%S"),duration,total_fee,entry_img))
        conn.commit()
        conn.close()
        return "Exit","Vehicle Exited",{"fee":total_fee,"time":duration}
    else:
        occupied,limit=get_free_spots(v_type)
        if occupied>=limit:
            conn.close()
            return "Error",f"No {v_type} spots available!",None
        entry_time=datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        c.execute("INSERT INTO active_parking(plate_number,vehicle_type,entry_time,image_path) VALUES(?,?,?,?)",(plate_text,v_type,entry_time,img_path))
        conn.commit()
        conn.close()
        return "Entry","Vehicle Entered",None

def calculate_fee(entry_time,vehicle_type):
    cfg=get_config()
    rate=cfg[4] if vehicle_type=='car' else cfg[5]
    wiggle=cfg[6]
    exit_time=datetime.now()
    duration_sec=(exit_time-entry_time).total_seconds()
    duration_min=round(duration_sec/60,2)
    
    # --- CAL START ---
    if duration_min <= 60:
        # If under 1 hour, force charge to 1 hour (Minimum Price)
        billable_hours = 1
    else:
        # If over 1 hour, apply wiggle room
        adjusted_min=duration_min-wiggle
        if adjusted_min<=0:
            billable_hours=0
        else:
            billable_hours=math.ceil(adjusted_min/60)

    total_fee=billable_hours*rate
    return total_fee,duration_min,exit_time

def get_total_revenue():
    conn=sqlite3.connect(DB_NAME)
    c=conn.cursor()
    c.execute("SELECT SUM(total_fee) FROM transaction_history")
    result=c.fetchone()[0]
    conn.close()
    return result if result else 0.0